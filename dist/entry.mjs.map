{"version":3,"file":"entry.mjs","names":["schema: T","fieldErrors: Record<string, string[]>","AuthCreationToken","jwtService: JwtService","refreshTokenSecret: string","AuthGuardStrategy","AuthStragetyModule","JWTAuthGuard"],"sources":["../src/ZodPipe/ZodParserValidation.ts","../src/authStrategy/authSignJWT.ts","../src/authStrategy/authStrategy.guard.ts","../src/authStrategy/authStrategy.module.ts","../src/authStrategy/authJWTGuard.ts"],"sourcesContent":["import {ArgumentMetadata, BadRequestException, Injectable, PipeTransform} from '@nestjs/common'\r\nimport z, { ZodError, ZodType } from 'zod'\r\n\r\nexport class ZodValidationPipe<T extends ZodType<any, any, any>> implements PipeTransform {\r\n\r\n    constructor(\r\n        private schema: T\r\n    ) {}\r\n\r\n    transform(value: any, metadata: ArgumentMetadata): z.infer<T> {\r\n        const paredValue = this.schema.safeParse(value)\r\n\r\n        if (paredValue.success) {\r\n            return paredValue.data\r\n        }\r\n\r\n        throw new BadRequestException({\r\n            source: metadata.type,\r\n            errors: this.formatZodErrors(paredValue.error)\r\n        })\r\n    }\r\n\r\n\r\n    private formatZodErrors(error: ZodError) {\r\n        const fieldErrors: Record<string, string[]> = {};\r\n        const formattedData = error.format();\r\n\r\n        for (const [key, entry] of Object.entries(formattedData) as [string, {_errors: string[]}][]) {\r\n            if (key === '_errors') continue\r\n            if (entry && entry._errors.length > 0) {\r\n                fieldErrors[key] = entry._errors\r\n            }\r\n        }\r\n\r\n        return fieldErrors\r\n  }\r\n}\r\n\r\n\r\n// {\r\n    // _errors: [],\r\n    // login: { _errors: [\"String must contain at least 1 character(s)\"] },\r\n    // email: { _errors: [\"Invalid email\"] },\r\n    // password: { _errors: [\"String must contain at least 6 character(s)\"] },\r\n    // passwordConfirm: { _errors: [\"Passwords do not match\"] }\r\n    // }\r\n\r\n    // we have this type take and give as [string, {_errors: string[]}][]","import { Injectable, Inject } from \"@nestjs/common\";\r\nimport {JwtService} from '@nestjs/jwt'\r\n\r\n\r\n\r\n@Injectable()\r\nexport class AuthCreationToken {\r\n    constructor(\r\n        private jwtService: JwtService,\r\n        @Inject('JWT_REFRESH_SECRET')\r\n        private readonly refreshTokenSecret: string\r\n    ) {}\r\n\r\n    async creationAccessToken(user: {id: number, login: string}) {\r\n        const payload = {sub: user.id, login: user.login}\r\n\r\n        console.log('Data for creation token', payload);\r\n\r\n        return {\r\n            accessToken: await this.jwtService.signAsync(payload)\r\n        }\r\n    }\r\n\r\n    async createtionRefreshToken(user: {id: number, login: string}) {\r\n        const payload = {sub: user.id}\r\n\r\n        console.log('Create refresh-token', payload);\r\n        \r\n        return {\r\n            refreshToken: await this.jwtService.signAsync(payload, { expiresIn: '7d', secret: this.refreshTokenSecret})\r\n        }\r\n    }\r\n\r\n    async getDataFromRefreshToken(refrechToken: string): Promise<{id: number, login: string}> {\r\n        \r\n        const payload = this.jwtService.verifyAsync(refrechToken, {\r\n            secret: this.refreshTokenSecret\r\n        })\r\n\r\n        return payload\r\n    }\r\n}","import {Injectable } from \"@nestjs/common\";\r\nimport {PassportStrategy} from '@nestjs/passport'\r\nimport { ExtractJwt, Strategy } from \"passport-jwt\";\r\nimport {ConfigService} from '@nestjs/config'\r\n\r\n\r\n@Injectable()\r\nexport class AuthGuardStrategy extends PassportStrategy(Strategy, 'jwt') {\r\n    constructor(\r\n        configService: ConfigService,\r\n    ) {\r\n        super({\r\n            jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),\r\n            ignoreExpiration: false,\r\n            secretOrKey: configService.get<string>('JWT_SECRET') || ''\r\n        })\r\n    }\r\n\r\n    async validate(payload: {sub: number, login: string, role: string}) : Promise<{userId: number, login: string, role: string}>\r\n    {   // sub is userId\r\n        console.log('Data we get from reqeust token', payload);\r\n        \r\n        return {userId: payload.sub, login: payload.login, role: payload.role}\r\n    }\r\n}\r\n\r\n","import { Module, DynamicModule, Inject } from '@nestjs/common'\r\nimport { AuthCreationToken } from './authSignJWT';\r\nimport { AuthGuardStrategy } from './authStrategy.guard';\r\n\r\n\r\n\r\n@Module({})\r\nexport class AuthStragetyModule {\r\n    static registerAsync(options: {\r\n        inject: any[],\r\n        useFactory: (...args: any[]) => {refrechTokenSecret: string}\r\n    }): DynamicModule {\r\n        return {\r\n            module: AuthStragetyModule,\r\n            providers: [AuthCreationToken, AuthGuardStrategy,\r\n                {\r\n                    provide: 'JWT_REFRESH_SECRET',\r\n                    inject: options.inject,\r\n                    useFactory: (...args: any[]) => options.useFactory(...args).refrechTokenSecret\r\n                }\r\n            ],\r\n            controllers: [],\r\n            exports: [AuthCreationToken, AuthGuardStrategy],\r\n        }\r\n    }\r\n}","import { ExecutionContext, Injectable, UnauthorizedException } from \"@nestjs/common\";\r\nimport { AuthGuard } from \"@nestjs/passport\";\r\n\r\n\r\n\r\n@Injectable()\r\nexport class JWTAuthGuard extends AuthGuard('jwt') {\r\n    handleRequest<TUser = any>(err: any, user: any, info: any, context: ExecutionContext, status?: any): TUser {\r\n        if (err || !user) {\r\n            throw err || new UnauthorizedException('Token is not validate')\r\n        }\r\n        return user\r\n    }\r\n}"],"mappings":";;;;;;;AAGA,IAAa,oBAAb,MAA0F;CAEtF,YACI,AAAQA,QACV;EADU;;CAGZ,UAAU,OAAY,UAAwC;EAC1D,MAAM,aAAa,KAAK,OAAO,UAAU,MAAM;AAE/C,MAAI,WAAW,QACX,QAAO,WAAW;AAGtB,QAAM,IAAI,oBAAoB;GAC1B,QAAQ,SAAS;GACjB,QAAQ,KAAK,gBAAgB,WAAW,MAAM;GACjD,CAAC;;CAIN,AAAQ,gBAAgB,OAAiB;EACrC,MAAMC,cAAwC,EAAE;EAChD,MAAM,gBAAgB,MAAM,QAAQ;AAEpC,OAAK,MAAM,CAAC,KAAK,UAAU,OAAO,QAAQ,cAAc,EAAqC;AACzF,OAAI,QAAQ,UAAW;AACvB,OAAI,SAAS,MAAM,QAAQ,SAAS,EAChC,aAAY,OAAO,MAAM;;AAIjC,SAAO;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC5BR,8BAAMC,oBAAkB;CAC3B,YACI,AAAQC,YACR,AACiBC,oBACnB;EAHU;EAES;;CAGrB,MAAM,oBAAoB,MAAmC;EACzD,MAAM,UAAU;GAAC,KAAK,KAAK;GAAI,OAAO,KAAK;GAAM;AAEjD,UAAQ,IAAI,2BAA2B,QAAQ;AAE/C,SAAO,EACH,aAAa,MAAM,KAAK,WAAW,UAAU,QAAQ,EACxD;;CAGL,MAAM,uBAAuB,MAAmC;EAC5D,MAAM,UAAU,EAAC,KAAK,KAAK,IAAG;AAE9B,UAAQ,IAAI,wBAAwB,QAAQ;AAE5C,SAAO,EACH,cAAc,MAAM,KAAK,WAAW,UAAU,SAAS;GAAE,WAAW;GAAM,QAAQ,KAAK;GAAmB,CAAC,EAC9G;;CAGL,MAAM,wBAAwB,cAA4D;AAMtF,SAJgB,KAAK,WAAW,YAAY,cAAc,EACtD,QAAQ,KAAK,oBAChB,CAAC;;;;CAhCT,YAAY;oBAIJ,OAAO,qBAAqB;;;;;;;ACF9B,8BAAMC,4BAA0B,iBAAiB,UAAU,MAAM,CAAC;CACrE,YACI,eACF;AACE,QAAM;GACF,gBAAgB,WAAW,6BAA6B;GACxD,kBAAkB;GAClB,aAAa,cAAc,IAAY,aAAa,IAAI;GAC3D,CAAC;;CAGN,MAAM,SAAS,SACf;AACI,UAAQ,IAAI,kCAAkC,QAAQ;AAEtD,SAAO;GAAC,QAAQ,QAAQ;GAAK,OAAO,QAAQ;GAAO,MAAM,QAAQ;GAAK;;;gCAhB7E,YAAY;;;;;ACCN,qDAAMC,qBAAmB;CAC5B,OAAO,cAAc,SAGH;AACd,SAAO;GACH;GACA,WAAW;IAAC;IAAmB;IAC3B;KACI,SAAS;KACT,QAAQ,QAAQ;KAChB,aAAa,GAAG,SAAgB,QAAQ,WAAW,GAAG,KAAK,CAAC;KAC/D;IACJ;GACD,aAAa,EAAE;GACf,SAAS,CAAC,mBAAmB,kBAAkB;GAClD;;;uDAjBR,OAAO,EAAE,CAAC;;;;ACAJ,yBAAMC,uBAAqB,UAAU,MAAM,CAAC;CAC/C,cAA2B,KAAU,MAAW,MAAW,SAA2B,QAAqB;AACvG,MAAI,OAAO,CAAC,KACR,OAAM,OAAO,IAAI,sBAAsB,wBAAwB;AAEnE,SAAO;;;2BANd,YAAY"}